name: Build and Release

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ steps.version.outputs.build_number }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: version
        run: |
          BUILD_NUMBER=$(git rev-list --count HEAD)
          BASE_VERSION=$(grep -oPm1 "(?<=<version>)[^<]+" pom.xml | head -1)
          VERSION="${BASE_VERSION}.${BUILD_NUMBER}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT

  build-windows:
    needs: prepare
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 25
          cache: maven

      - shell: pwsh
        run: |
          $v = "${{ needs.prepare.outputs.version }}"
          (Get-Content pom.xml) -replace '<version>1\.0\.0</version>', "<version>$v</version>" | Set-Content pom.xml

      - run: mvn clean package -DskipTests

      - shell: pwsh
        run: |
          Invoke-WebRequest https://download.oracle.com/java/25/latest/jdk-25_windows-x64_bin.zip -OutFile jdk.zip
          Expand-Archive jdk.zip .
          Rename-Item (Get-ChildItem -Directory jdk-*) jdk-25

      - shell: pwsh
        run: |
          Invoke-WebRequest https://download2.gluonhq.com/openjfx/25/openjfx-25_windows-x64_bin-jmods.zip -OutFile javafx.zip
          Expand-Archive javafx.zip .
          Move-Item javafx-jmods-25\javafx-jmods-25\* javafx-jmods-25\
          Remove-Item javafx-jmods-25\javafx-jmods-25 -Recurse

      - shell: pwsh
        run: |
          Remove-Item runtime -Recurse -Force -ErrorAction SilentlyContinue
          .\jdk-25\bin\jlink `
            --module-path ".\jdk-25\jmods;.\javafx-jmods-25" `
            --add-modules `
              java.base,java.desktop,java.logging,java.xml,java.naming,java.sql,`
              java.management,java.instrument,java.prefs,java.net.http,`
              jdk.crypto.ec,jdk.unsupported,`
              javafx.controls,javafx.fxml,javafx.graphics,javafx.graphics.win `
            --output runtime `
            --compress=2 `
            --no-header-files `
            --no-man-pages `
            --strip-debug

      - shell: pwsh
        run: choco install wixtoolset -y

      - shell: pwsh
        run: |
          mkdir package-input
          Copy-Item target/tunneller-router-${{ needs.prepare.outputs.version }}.jar package-input/app.jar
          .\jdk-25\bin\jpackage `
            --type exe `
            --input package-input `
            --main-jar app.jar `
            --main-class com.tunneller.App `
            --name "Tunneller Router" `
            --runtime-image runtime `
            --app-version "${{ needs.prepare.outputs.version }}" `
            --vendor "JS Enterprise" `
            --win-menu `
            --win-shortcut `
            --win-console `
            --dest installer-output

      - uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: installer-output/*.exe

  build-linux:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 25
          cache: maven

      - run: |
          sed -i "s/<version>1\.0\.0<\/version>/<version>${{ needs.prepare.outputs.version }}<\/version>/" pom.xml

      - run: mvn clean package -DskipTests

      - run: |
          wget -q https://download.oracle.com/java/25/latest/jdk-25_linux-x64_bin.tar.gz
          tar -xzf jdk-25_linux-x64_bin.tar.gz
          mv jdk-* jdk-25

      - run: |
          wget -q https://download2.gluonhq.com/openjfx/25/openjfx-25_linux-x64_bin-jmods.zip
          unzip -q openjfx-25_linux-x64_bin-jmods.zip
          mv javafx-jmods-25/javafx-jmods-25/* javafx-jmods-25/
          rm -rf javafx-jmods-25/javafx-jmods-25

      - run: |
          ./jdk-25/bin/jlink \
            --module-path ./jdk-25/jmods:./javafx-jmods-25 \
            --add-modules \
              java.base,java.desktop,java.logging,java.xml,java.naming,java.sql, \
              java.management,java.instrument,java.prefs,java.net.http, \
              jdk.crypto.ec,jdk.unsupported, \
              javafx.controls,javafx.fxml,javafx.graphics,javafx.graphics.linux \
            --output runtime \
            --compress=2 \
            --no-header-files \
            --no-man-pages \
            --strip-debug

      - run: sudo apt-get update && sudo apt-get install -y fakeroot binutils

      - run: |
          mkdir package-input
          cp target/tunneller-router-${{ needs.prepare.outputs.version }}.jar package-input/app.jar
          ./jdk-25/bin/jpackage \
            --type deb \
            --input package-input \
            --main-jar app.jar \
            --main-class com.tunneller.App \
            --name "Tunneller Router" \
            --runtime-image runtime \
            --app-version "${{ needs.prepare.outputs.version }}" \
            --vendor "JS Enterprise" \
            --linux-shortcut \
            --dest installer-output

      - uses: actions/upload-artifact@v4
        with:
          name: linux-installer
          path: installer-output/*.deb
